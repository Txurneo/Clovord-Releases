# .github/workflows/publish-ready-release.yml
name: Publish ready draft releases

on:
  schedule:
    - cron: '*/10 * * * *'       # alle 5 Minuten
  workflow_dispatch:

jobs:
  publish-ready:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # nötig für gh release edit
    env:
      GH_TOKEN: ${{ github.token }}
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.repository }}
      REQUIRED_ASSETS: |
        Clovord Setup.exe
        latest.yml
    steps:
      - name: Look for drafts that have all required assets
        id: check
        run: |
          publish_list=""
          drafts=$(gh api "repos/$REPO/releases" --paginate --jq '.[] | select(.draft == true) | {id: .id, tag_name: .tag_name, assets: [.assets[] | {name: .name, state: .state, size: .size}] }')

          if [ -z "$drafts" ]; then
            echo "No draft releases."
            exit 0
          fi

          while read -r draft; do
            [ -z "$draft" ] && continue
            tag=$(echo "$draft" | jq -r '.tag_name')
            assets=$(echo "$draft" | jq -r '.assets')

            missing=0
            while read -r asset; do
              [ -z "$asset" ] && continue
              match=$(echo "$assets" | jq --arg name "$asset" 'map(select(.name == $name and .state == "uploaded" and .size > 0)) | length')
              if [ "$match" -eq 0 ]; then
                missing=1
                echo "Still waiting for asset $asset in $tag"
                break
              fi
            done <<< "$REQUIRED_ASSETS"

            if [ "$missing" -eq 0 ]; then
              publish_list="$publish_list $tag"
            fi
          done <<< "$(echo "$drafts" | jq -c '.')" 

          if [ -z "$publish_list" ]; then
            exit 0
          fi

          echo "ready_tags=$publish_list" >> $GITHUB_OUTPUT

      - name: Publish all ready drafts
        if: steps.check.outputs.ready_tags != ''
        run: |
          for tag in ${{ steps.check.outputs.ready_tags }}; do
            echo "Publishing $tag"
            gh release edit "$tag" --draft=false --prerelease=false
          done
