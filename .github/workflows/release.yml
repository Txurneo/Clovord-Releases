# .github/workflows/publish-release.yml
name: Publish release after assets uploaded

on:
  release:
    types: [created, edited]   # feuert, sobald du den Draft anlegst

concurrency:
  group: publish-${{ github.event.release.id }}
  cancel-in-progress: false

jobs:
  publish-when-assets-ready:
    if: github.event.release.draft == true
    runs-on: ubuntu-latest
    permissions:
      contents: write   # nötig fürs Editieren der Releases
    env:
      GH_TOKEN: ${{ github.token }}
      TAG_NAME: ${{ github.event.release.tag_name }}
      REPO: ${{ github.repository }}
      REQUIRED_ASSETS: |
        Clovord Setup.exe
        latest.yml
    steps:
      - name: Wait until required assets are uploaded
        run: |
          asset_ready() {
            local name="$1"
            gh api "repos/$REPO/releases/tags/$TAG_NAME" \
              --jq ".assets[] | select(.name == \"$name\") | {state:.state,size:.size}" \
              | jq 'select(.state == "uploaded" and .size > 0)' >/dev/null
          }
          for attempt in {1..60}; do
            missing=0
            while read -r asset; do
              [[ -z "$asset" ]] && continue
              if ! asset_ready "$asset"; then
                missing=1
                break
              fi
            done <<< "$REQUIRED_ASSETS"
            if [[ $missing -eq 0 ]]; then
              echo "All assets uploaded."
              exit 0
            fi
            echo "Waiting for assets… ($attempt/60)"
            sleep 10
          done
          echo "::error::Timed out waiting for required assets."
          exit 1
      - name: Publish release
        if: success()
        run: |
          gh release edit "$TAG_NAME" --draft=false --prerelease=false
